#!/bin/sh
# referenced pi-bluetooth, bluetooth helper for Revolution Pi BT

set -e

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <bluetooth hci device>"
    exit 0
fi

dev=$1

# Need to bring hci up before looking at MAC as it can be all zeros during init
# TODO: address prefix for Revpi devices needed.
/bin/hciconfig $dev up
if ! /bin/hciconfig $dev | grep -q "BD Address: B8:27:EB:E"; then
    echo Not UART-attached BT Modem on Revolution Pi
    exit 0
fi


# Force reinitialisation to allow extra features such as Secure Simple Pairing
# to be enabled
/usr/bin/bluetoothctl power off
/usr/bin/bluetoothctl power on
echo "OK" > /home/pi/bthelper-executed
